<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sender</title>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <h1>Screen Share</h1>
    <h2>Sender</h2>
    <p><button id="share">Share Screen</button></p>
    <video id="preview" autoplay muted></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    const socket = io();
    socket.emit("join", "sender");

    let pc;
    let stream;

    function createPeer() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.onicecandidate = e => {
        if (e.candidate) socket.emit("ice", e.candidate);
      };

      socket.on("ice", c => pc.addIceCandidate(c));
      socket.on("answer", a => pc.setRemoteDescription(a));
    }

    async function makeOffer() {
      pc?.close();
      createPeer();

      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", offer);
    }

    document.getElementById("share").onclick = async () => {
      stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      preview.srcObject = stream;
      makeOffer();
    };

    socket.on("receiver-ready", () => {
      if (stream) makeOffer();
    });
    </script>
  </body>
</html>